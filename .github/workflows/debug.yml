name: Debug CI/CD - Step by Step

on:
  workflow_dispatch:  # Manual trigger

jobs:
  debug-step-by-step:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸŽ¯ Step 1: Checkout
      id: checkout
      uses: actions/checkout@v3
      continue-on-error: false
    
    - name: ðŸ“ Step 2: List Files
      id: list-files
      run: |
        echo "=== Current directory ==="
        pwd
        echo ""
        echo "=== All files ==="
        find . -type f -name "*.yml" -o -name "*.yaml" -o -name "*.env*" | sort
        echo ""
        echo "=== Top-level files ==="
        ls -la
        echo ""
        echo "=== Docker Compose file ==="
        if [ -f "docker-compose.yml" ]; then
          echo "âœ… docker-compose.yml exists"
          head -20 docker-compose.yml
        else
          echo "âŒ docker-compose.yml missing"
          exit 1
        fi
    
    - name: ðŸ“„ Step 3: Check .env.example
      id: check-env
      run: |
        echo "=== Checking .env.example ==="
        if [ -f ".env.example" ]; then
          echo "âœ… .env.example exists"
          echo "First few lines:"
          head -5 .env.example
        else
          echo "âš ï¸ .env.example does not exist, creating minimal one..."
          echo "DB_PASSWORD=test123" > .env.example
          echo "APP_ENV=testing" >> .env.example
          echo "Created minimal .env.example"
        fi
    
    - name: ðŸ”§ Step 4: Create .env from .env.example
      id: create-env
      run: |
        echo "=== Creating .env file ==="
        cp .env.example .env 2>/dev/null || {
          echo "âš ï¸ Could not copy .env.example, creating basic .env"
          echo "DB_PASSWORD=test123" > .env
          echo "APP_ENV=testing" >> .env
        }
        echo "âœ… .env file created"
        echo "Contents:"
        cat .env
    
    - name: ðŸ³ Step 5: Check Docker Installation
      id: check-docker
      run: |
        echo "=== Checking Docker ==="
        docker --version
        docker info --format '{{.ServerVersion}}'
        echo ""
        echo "=== Checking Docker Compose ==="
        docker-compose --version 2>/dev/null || docker compose version
    
    - name: âœ… Step 6: Validate Docker Compose Syntax
      id: validate-compose
      run: |
        echo "=== Validating docker-compose.yml ==="
        if docker-compose config > /dev/null 2>&1; then
          echo "âœ… docker-compose.yml syntax is valid"
        else
          echo "âŒ docker-compose.yml has syntax errors"
          echo "Running validation with output:"
          docker-compose config
          exit 1
        fi
    
    - name: ðŸ—ï¸ Step 7: Test Build (Dry Run)
      id: test-build
      run: |
        echo "=== Testing Docker build (dry run) ==="
        docker-compose build --no-cache --progress plain 2>&1 | head -50 || {
          echo "âš ï¸ Build had issues, but continuing..."
        }
    
    - name: ðŸš€ Step 8: Start Services (Test)
      id: test-services
      timeout-minutes: 2
      run: |
        echo "=== Starting services for test ==="
        # Start in background
        docker-compose up -d
        
        echo "Waiting 30 seconds for services..."
        sleep 30
        
        echo "=== Checking running containers ==="
        docker-compose ps
        
        echo "=== Checking service logs ==="
        docker-compose logs --tail=10
        
        echo "=== Simple port check ==="
        for port in 9000 9001 8081 3000 9090; do
          echo -n "Port $port: "
          nc -z localhost $port 2>/dev/null && echo "OPEN" || echo "CLOSED"
        done
    
    - name: ðŸ§¹ Step 9: Cleanup
      id: cleanup
      if: always()
      run: |
        echo "=== Cleaning up ==="
        docker-compose down -v 2>/dev/null || true
        echo "âœ… Cleanup complete"
    
    - name: âœ… Step 10: Success
      id: success
      if: success()
      run: echo "ðŸŽ‰ All steps completed successfully!"
