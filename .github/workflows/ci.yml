name: CI/CD Pipeline (Mac/Linux Compatible)

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout with LF line endings
      uses: actions/checkout@v3
      with:
        # Force LF line endings regardless of source
        lfs: false
        
    - name: ðŸ”§ Debug - Show what GitHub Actions sees
      run: |
        echo "=== Current directory ==="
        pwd
        
        echo ""
        echo "=== All files ==="
        ls -la
        
        echo ""
        echo "=== .env.example exists? ==="
        if [ -f ".env.example" ]; then
          echo "âœ… .env.example EXISTS"
          echo "File type:"
          file .env.example
          echo "First 5 lines:"
          head -5 .env.example | cat -A  # Show invisible characters
          echo "Line count:"
          wc -l .env.example
        else
          echo "âŒ .env.example NOT FOUND"
          echo "Creating it now..."
          echo "APP_ENV=testing" > .env.example
          echo "DB_PASSWORD=test123" >> .env.example
        fi
        
    - name: ðŸ“„ Create .env with proper line endings
      run: |
        echo "Creating .env file..."
        
        # Use tr to ensure LF line endings regardless of source
        if [ -f ".env.example" ]; then
          echo "Using .env.example with forced LF line endings..."
          tr -d '\r' < .env.example > .env
          
          # Ensure it ends with newline
          echo "" >> .env
          
          # Add CI-specific overrides
          echo "# CI Overrides" >> .env
          echo "APP_ENV=ci" >> .env
          echo "DB_PASSWORD=ci_$(date +%s)" >> .env
        else
          echo "Creating .env from scratch..."
          echo "APP_ENV=ci" > .env
          echo "DB_PASSWORD=ci_$(date +%s)" >> .env
        fi
        
        echo "âœ… Created .env with:"
        cat .env
        echo "File info:"
        file .env
        wc -l .env
        
    - name: âœ… Validate files
      run: |
        echo "=== File Validation ==="
        
        # Check all important files
        for f in .env.example .env docker-compose.yml; do
          if [ -f "$f" ]; then
            echo "âœ… $f exists"
            echo "   Type: $(file $f)"
            echo "   Lines: $(wc -l < $f)"
          else
            echo "âŒ $f missing"
          fi
        done
        
    - name: ðŸŽ‰ Success
      run: echo "âœ… CI/CD workflow completed!"
