name: PHP Microservices CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Setup .env file
      run: |
        echo "ðŸ”§ Setting up environment file..."
        
        # Check if .env.example exists
        if [ -f .env.example ]; then
          echo "âœ… .env.example found, creating .env for CI"
          cp .env.example .env
          
          # Override with CI-specific values
          echo "APP_ENV=testing" >> .env
          echo "APP_DEBUG=false" >> .env
          echo "DB_PASSWORD=ci_test_password_123" >> .env
          echo "CI_MODE=true" >> .env
          
          # Set CI-specific ports to avoid conflicts
          sed -i 's/API_PORT=9000/API_PORT=19000/g' .env
          sed -i 's/FRONTEND_PORT=3000/FRONTEND_PORT=13000/g' .env
          sed -i 's/NGINX_PORT=8081/NGINX_PORT=18081/g' .env
          sed -i 's/PROMETHEUS_PORT=9090/PROMETHEUS_PORT=19090/g' .env
          sed -i 's/GRAFANA_PORT=9001/GRAFANA_PORT=19001/g' .env
        else
          echo "âš ï¸ .env.example not found, creating .env from scratch"
          # Create minimal .env for CI
          cat > .env << 'ENVEOF'
          # CI Environment
          APP_ENV=testing
          APP_DEBUG=false
          DB_HOST=database
          DB_PORT=3306
          DB_DATABASE=ci_microservices
          DB_USERNAME=root
          DB_PASSWORD=ci_test_password_123
          API_PORT=19000
          FRONTEND_PORT=13000
          NGINX_PORT=18081
          PROMETHEUS_PORT=19090
          GRAFANA_PORT=19001
          CI_MODE=true
          ENVEOF
        fi
        
        echo "ðŸ“„ .env file contents:"
        cat .env
    
    - name: Update docker-compose.yml ports for CI
      run: |
        echo "ðŸ”„ Updating ports for CI environment..."
        
        # Check if we have .env with CI ports
        if grep -q "API_PORT=19000" .env; then
          echo "Using CI ports from .env file"
          
          # Read ports from .env file
          API_PORT=$(grep "API_PORT=" .env | cut -d'=' -f2)
          FRONTEND_PORT=$(grep "FRONTEND_PORT=" .env | cut -d'=' -f2)
          NGINX_PORT=$(grep "NGINX_PORT=" .env | cut -d'=' -f2)
          PROMETHEUS_PORT=$(grep "PROMETHEUS_PORT=" .env | cut -d'=' -f2)
          GRAFANA_PORT=$(grep "GRAFANA_PORT=" .env | cut -d'=' -f2)
          
          echo "CI Ports: API=$API_PORT, Frontend=$FRONTEND_PORT, Nginx=$NGINX_PORT"
          
          # Update docker-compose.yml with CI ports
          sed -i "s/\"9000:80\"/\"${API_PORT}:80\"/g" docker-compose.yml
          sed -i "s/\"3000:80\"/\"${FRONTEND_PORT}:80\"/g" docker-compose.yml
          sed -i "s/\"8081:80\"/\"${NGINX_PORT}:80\"/g" docker-compose.yml
          sed -i "s/\"9090:9090\"/\"${PROMETHEUS_PORT}:9090\"/g" docker-compose.yml
          
          # If you have Grafana service
          if grep -q "\"9001:3000\"" docker-compose.yml; then
            sed -i "s/\"9001:3000\"/\"${GRAFANA_PORT}:3000\"/g" docker-compose.yml
          fi
        else
          echo "Using default CI port offsets"
          # Fallback: Use fixed port offsets
          sed -i 's/"9000:80"/"19000:80"/g' docker-compose.yml
          sed -i 's/"3000:80"/"13000:80"/g' docker-compose.yml
          sed -i 's/"8081:80"/"18081:80"/g' docker-compose.yml
          sed -i 's/"9090:9090"/"19090:9090"/g' docker-compose.yml
          sed -i 's/"9001:3000"/"19001:3000"/g' docker-compose.yml 2>/dev/null || true
        fi
        
        echo "âœ… Updated docker-compose.yml ports"
        grep -n "ports:" docker-compose.yml -A 2
    
    - name: Validate Docker Compose
      run: |
        echo "ðŸ” Validating Docker Compose configuration..."
        docker-compose config
    
    - name: Build Docker images
      run: |
        echo "ðŸ—ï¸ Building Docker images..."
        docker-compose build --no-cache
    
    - name: Start services
      run: |
        echo "ðŸš€ Starting services..."
        docker-compose up -d
        
        # Wait for services to initialize
        echo "â³ Waiting for services to be ready..."
        sleep 30
        
        # Show running containers
        echo "ðŸ“¦ Running containers:"
        docker-compose ps
    
    - name: Health check services
      run: |
        echo "ðŸ¥ Performing health checks..."
        
        # Function to check service with retries
        check_service() {
          local service_name=$1
          local port=$2
          local endpoint=${3:-/}
          local max_attempts=10
          
          echo "Checking $service_name on port $port..."
          
          for i in $(seq 1 $max_attempts); do
            if curl -s -f "http://localhost:${port}${endpoint}" > /dev/null; then
              echo "âœ… $service_name is healthy"
              return 0
            fi
            echo "â³ Attempt $i/$max_attempts: $service_name not ready..."
            sleep 5
          done
          
          echo "âŒ $service_name failed health check after $max_attempts attempts"
          
          # Show logs for debugging
          echo "ðŸ“œ Logs for $service_name:"
          docker-compose logs --tail=20 "$service_name" 2>/dev/null || true
          
          return 1
        }
        
        # Read ports from .env for checking
        if [ -f .env ]; then
          source .env
          API_PORT=${API_PORT:-19000}
          FRONTEND_PORT=${FRONTEND_PORT:-13000}
          NGINX_PORT=${NGINX_PORT:-18081}
        else
          API_PORT=19000
          FRONTEND_PORT=13000
          NGINX_PORT=18081
        fi
        
        # Check API service
        check_service "api" "$API_PORT" "/health.php"
        
        # Check frontend
        check_service "frontend" "$FRONTEND_PORT"
        
        # Check Nginx if exists
        if docker-compose ps | grep -q nginx; then
          check_service "nginx" "$NGINX_PORT"
        fi
        
        echo "âœ… All health checks passed!"
    
    - name: Run API tests (if available)
      run: |
        echo "ðŸ§ª Running tests..."
        
        # Check if there's a test script
        if [ -f "api/tests/run.sh" ]; then
          echo "Running custom test script..."
          chmod +x api/tests/run.sh
          docker-compose exec -T api ./tests/run.sh
        elif [ -f "api/composer.json" ]; then
          echo "Checking for PHPUnit..."
          # Try to run PHPUnit tests
          docker-compose exec -T api php vendor/bin/phpunit --version 2>/dev/null && \
            docker-compose exec -T api php vendor/bin/phpunit || \
            echo "No PHPUnit tests found or configured"
        else
          echo "No tests configured"
        fi
    
    - name: Check logs for errors
      if: always()
      run: |
        echo "ðŸ“‹ Service logs (last 20 lines each):"
        docker-compose logs --tail=20
    
    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up..."
        docker-compose down -v --remove-orphans
        docker system prune -af
